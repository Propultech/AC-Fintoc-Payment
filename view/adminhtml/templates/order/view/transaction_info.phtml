<?php
/**
 * @var \Fintoc\Payment\Block\Adminhtml\Order\View\TransactionInfo $block
 */
/** @var \Magento\Framework\Escaper $escaper */


// Only display for Fintoc payments
if (!$block->isFintocPayment()) {
    return;
}

$transactions = $block->getTransactionHistory();
?>

<?php if (empty($transactions)): ?>
    <div class="admin__page-section-item-content">
        <div class="message info empty">
            <span><?= $escaper->escapeHtml(__('No Fintoc transactions found for this order.')) ?></span>
        </div>
    </div>
<?php else: ?>
    <div class="admin__page-section-title">
        <span class="title"><?= $escaper->escapeHtml($block->getData('title')) ?></span>
    </div>
    <div class="admin__page-section-content">
        <div class="fintoc-transactions">
            <div class="admin__control-table-wrapper">
                <table class="data-table admin__control-table">
                    <thead>
                        <tr>
                            <th class="col-transaction-id"><?= $escaper->escapeHtml(__('Transaction ID')) ?></th>
                            <th class="col-type"><?= $escaper->escapeHtml(__('Type')) ?></th>
                            <th class="col-status"><?= $escaper->escapeHtml(__('Status')) ?></th>
                            <th class="col-amount"><?= $escaper->escapeHtml(__('Amount')) ?></th>
                            <th class="col-date"><?= $escaper->escapeHtml(__('Date')) ?></th>
                            <th class="col-actions"><?= $escaper->escapeHtml(__('Actions')) ?></th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($transactions as $transaction): ?>
                            <tr>
                                <td class="col-transaction-id">
                                    <?= $escaper->escapeHtml($transaction->getTransactionId()) ?>
                                </td>
                                <td class="col-type">
                                    <?= $escaper->escapeHtml($block->getTransactionTypeLabel($transaction->getType())) ?>
                                </td>
                                <td class="col-status">
                                    <span class="<?= $escaper->escapeHtmlAttr($block->getTransactionStatusClass($transaction->getStatus())) ?>">
                                        <span><?= $escaper->escapeHtml($block->getTransactionStatusLabel($transaction->getStatus())) ?></span>
                                    </span>
                                </td>
                                <td class="col-amount">
                                    <?= $escaper->escapeHtml($block->formatAmount($transaction->getAmount(), $transaction->getCurrency())) ?>
                                </td>
                                <td class="col-date">
                                    <?= $escaper->escapeHtml($block->formatDateTimeExact($transaction->getCreatedAt())) ?>
                                </td>
                                <td class="col-actions">
                                    <a href="#" class="action-show-hide" data-transaction-id="<?= $escaper->escapeHtmlAttr($transaction->getEntityId()) ?>">
                                        <?= $escaper->escapeHtml(__('Details')) ?>
                                    </a>
                                    <?php if (strtolower((string)$transaction->getType()) === 'refund' && strtolower((string)$transaction->getStatus()) === 'pending'): ?>
                                        <form method="post" action="<?= $escaper->escapeUrl($block->getUrl('fintoc_refunds/refund/cancel')) ?>" style="display:inline-block; margin-left:10px;">
                                            <?= /* form key */ $block->getBlockHtml('formkey') ?>
                                            <?php $order = $block->getOrder(); ?>
                                            <?php if ($order): ?>
                                                <input type="hidden" name="order_id" value="<?= (int)$order->getId() ?>" />
                                            <?php endif; ?>
                                            <input type="hidden" name="refund_id" value="<?= $escaper->escapeHtmlAttr($transaction->getTransactionId()) ?>" />
                                            <button type="submit" class="action-secondary" onclick="return confirm('<?= $escaper->escapeJs(__('Are you sure you want to cancel this refund?')) ?>');">
                                                <span><?= $escaper->escapeHtml(__('Cancel Refund')) ?></span>
                                            </button>
                                        </form>
                                    <?php endif; ?>
                                </td>
                            </tr>
                            <tr id="transaction-details-<?= $escaper->escapeHtmlAttr($transaction->getEntityId()) ?>" class="transaction-details" style="display: none;">
                                <td colspan="6">
                                    <div class="transaction-details-content">
                                        <div class="transaction-section">
                                            <h4><?= $escaper->escapeHtml(__('Transaction Details')) ?></h4>
                                            <table class="data-table">
                                                <tr>
                                                    <th><?= $escaper->escapeHtml(__('Transaction ID')) ?></th>
                                                    <td><?= $escaper->escapeHtml($transaction->getTransactionId()) ?></td>
                                                </tr>
                                                <?php if ($transaction->getReference()): ?>
                                                <tr>
                                                    <th><?= $escaper->escapeHtml(__('Reference')) ?></th>
                                                    <td><?= $escaper->escapeHtml($transaction->getReference()) ?></td>
                                                </tr>
                                                <?php endif; ?>
                                                <tr>
                                                    <th><?= $escaper->escapeHtml(__('Type')) ?></th>
                                                    <td><?= $escaper->escapeHtml($block->getTransactionTypeLabel($transaction->getType())) ?></td>
                                                </tr>
                                                <tr>
                                                    <th><?= $escaper->escapeHtml(__('Status')) ?></th>
                                                    <td>
                                                        <span class="<?= $escaper->escapeHtmlAttr($block->getTransactionStatusClass($transaction->getStatus())) ?>">
                                                            <span><?= $escaper->escapeHtml($block->getTransactionStatusLabel($transaction->getStatus())) ?></span>
                                                        </span>
                                                    </td>
                                                </tr>
                                                <?php if ($transaction->getPreviousStatus()): ?>
                                                <tr>
                                                    <th><?= $escaper->escapeHtml(__('Previous Status')) ?></th>
                                                    <td>
                                                        <span class="<?= $escaper->escapeHtmlAttr($block->getTransactionStatusClass($transaction->getPreviousStatus())) ?>">
                                                            <span><?= $escaper->escapeHtml($block->getTransactionStatusLabel($transaction->getPreviousStatus())) ?></span>
                                                        </span>
                                                    </td>
                                                </tr>
                                                <?php endif; ?>
                                                <tr>
                                                    <th><?= $escaper->escapeHtml(__('Amount')) ?></th>
                                                    <td><?= $escaper->escapeHtml($block->formatAmount($transaction->getAmount(), $transaction->getCurrency())) ?></td>
                                                </tr>
                                                <tr>
                                                    <th><?= $escaper->escapeHtml(__('Currency')) ?></th>
                                                    <td><?= $escaper->escapeHtml($transaction->getCurrency()) ?></td>
                                                </tr>
                                                <tr>
                                                    <th><?= $escaper->escapeHtml(__('Created At')) ?></th>
                                                    <td><?= $escaper->escapeHtml($block->formatDateTimeExact($transaction->getCreatedAt())) ?></td>
                                                </tr>
                                                <?php if ($transaction->getUpdatedAt() && $transaction->getUpdatedAt() != $transaction->getCreatedAt()): ?>
                                                <tr>
                                                    <th><?= $escaper->escapeHtml(__('Updated At')) ?></th>
                                                    <td><?= $escaper->escapeHtml($block->formatDateTimeExact($transaction->getUpdatedAt())) ?></td>
                                                </tr>
                                                <?php endif; ?>
                                                <?php if ($transaction->getCreatedBy()): ?>
                                                <tr>
                                                    <th><?= $escaper->escapeHtml(__('Created By')) ?></th>
                                                    <td><?= $escaper->escapeHtml($transaction->getCreatedBy()) ?></td>
                                                </tr>
                                                <?php endif; ?>
                                                <?php if ($transaction->getUpdatedBy()): ?>
                                                <tr>
                                                    <th><?= $escaper->escapeHtml(__('Updated By')) ?></th>
                                                    <td><?= $escaper->escapeHtml($transaction->getUpdatedBy()) ?></td>
                                                </tr>
                                                <?php endif; ?>
                                                <?php if ($transaction->getErrorCode() || $transaction->getErrorMessage()): ?>
                                                <tr>
                                                    <th><?= $escaper->escapeHtml(__('Error')) ?></th>
                                                    <td>
                                                        <?php if ($transaction->getErrorCode()): ?>
                                                            <strong><?= $escaper->escapeHtml(__('Code')) ?>:</strong> <?= $escaper->escapeHtml($transaction->getErrorCode()) ?><br>
                                                        <?php endif; ?>
                                                        <?php if ($transaction->getErrorMessage()): ?>
                                                            <strong><?= $escaper->escapeHtml(__('Message')) ?>:</strong> <?= $escaper->escapeHtml($transaction->getErrorMessage()) ?>
                                                        <?php endif; ?>
                                                    </td>
                                                </tr>
                                                <?php endif; ?>
                                            </table>
                                        </div>

                                        <?php if ($transaction->getRequestData()): ?>
                                        <div class="transaction-section">
                                            <h4><?= $escaper->escapeHtml(__('Request Data')) ?></h4>
                                            <pre class="transaction-data"><?= $escaper->escapeHtml(json_encode($block->decodeData($transaction->getRequestData()), JSON_PRETTY_PRINT)) ?></pre>
                                        </div>
                                        <?php endif; ?>

                                        <?php if ($transaction->getResponseData()): ?>
                                        <div class="transaction-section">
                                            <h4><?= $escaper->escapeHtml(__('Response Data')) ?></h4>
                                            <pre class="transaction-data"><?= $escaper->escapeHtml(json_encode($block->decodeData($transaction->getResponseData()), JSON_PRETTY_PRINT)) ?></pre>
                                        </div>
                                        <?php endif; ?>

                                        <?php if ($transaction->getWebhookData()): ?>
                                        <div class="transaction-section">
                                            <h4><?= $escaper->escapeHtml(__('Webhook Data')) ?></h4>
                                            <pre class="transaction-data"><?= $escaper->escapeHtml(json_encode($block->decodeData($transaction->getWebhookData()), JSON_PRETTY_PRINT)) ?></pre>
                                        </div>
                                        <?php endif; ?>

                                        <?php
                                        $statusHistory = $block->getStatusHistory($transaction);
                                        if (!empty($statusHistory)):
                                            ?>
                                        <div class="transaction-section">
                                            <h4><?= $escaper->escapeHtml(__('Status History')) ?></h4>
                                            <table class="data-table">
                                                <thead>
                                                    <tr>
                                                        <th><?= $escaper->escapeHtml(__('Date')) ?></th>
                                                        <th><?= $escaper->escapeHtml(__('From')) ?></th>
                                                        <th><?= $escaper->escapeHtml(__('To')) ?></th>
                                                        <th><?= $escaper->escapeHtml(__('User')) ?></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <?php foreach ($statusHistory as $history): ?>
                                                    <tr>
                                                        <td><?= $escaper->escapeHtml($block->formatDateTimeExact($history['timestamp'] ?? '')) ?></td>
                                                        <td>
                                                            <?php if (isset($history['from'])): ?>
                                                            <span class="<?= $escaper->escapeHtmlAttr($block->getTransactionStatusClass($history['from'])) ?>">
                                                                <span><?= $escaper->escapeHtml($block->getTransactionStatusLabel($history['from'])) ?></span>
                                                            </span>
                                                            <?php endif; ?>
                                                        </td>
                                                        <td>
                                                            <?php if (isset($history['to'])): ?>
                                                            <span class="<?= $escaper->escapeHtmlAttr($block->getTransactionStatusClass($history['to'])) ?>">
                                                                <span><?= $escaper->escapeHtml($block->getTransactionStatusLabel($history['to'])) ?></span>
                                                            </span>
                                                            <?php endif; ?>
                                                        </td>
                                                        <td><?= $escaper->escapeHtml($history['user'] ?? '') ?></td>
                                                    </tr>
                                                    <?php endforeach; ?>
                                                </tbody>
                                            </table>
                                        </div>
                                        <?php endif; ?>
                                    </div>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <style>
        .transaction-details-content {
            padding: 15px;
            background: #f8f8f8;
            border: 1px solid #e3e3e3;
            margin-bottom: 15px;
        }
        .transaction-section {
            margin-bottom: 20px;
        }
        .transaction-section h4 {
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e3e3e3;
        }
        .transaction-data {
            background: #fff;
            padding: 10px;
            border: 1px solid #e3e3e3;
            max-height: 300px;
            overflow: auto;
            font-size: 12px;
        }
    </style>

    <script>
        require(['jquery'], function($) {
            $('.action-show-hide').on('click', function(e) {
                e.preventDefault();
                var transactionId = $(this).data('transaction-id');
                $('#transaction-details-' + transactionId).toggle();

                if ($(this).text() === '<?= $escaper->escapeJs(__('Details')) ?>') {
                    $(this).text('<?= $escaper->escapeJs(__('Hide')) ?>');
                } else {
                    $(this).text('<?= $escaper->escapeJs(__('Details')) ?>');
                }
            });
        });
    </script>
<?php endif; ?>
