<?php
/** @var \Fintoc\Payment\Block\Adminhtml\Refund\Create $block */
/** @var \Magento\Framework\Escaper $escaper */

$order = $block->getOrder();
?>
<div class="page-main-actions">
    <div class="page-actions">
        <?php if ($order): ?>
            <a href="<?= $escaper->escapeUrl($block->getUrl('sales/order/view', ['order_id' => $order->getId()])) ?>"
               class="action-secondary">
                <?= $escaper->escapeHtml(__('Back to Order')) ?>
            </a>
        <?php endif; ?>
    </div>
</div>

<?php if (!$order): ?>
    <div class="message message-error">
        <div><?= $escaper->escapeHtml(__('Order not found or missing.')) ?></div>
    </div>
    <?php return; endif; ?>

<?php
$refundable = $block->getRefundableAmount($order);
$items = $block->getItemData($order);
$currencyCode = $block->getCurrencyCode($order);
$allowPartial = $block->isPartialAllowed();
?>
<form action="<?= $escaper->escapeUrl($block->getUrl('fintoc_refunds/refund/save')) ?>" method="post"
      id="fintoc-refund-form"
      data-mage-init='{"Fintoc_Payment/js/refund-create": {"allowPartial": <?= $allowPartial ? 'true' : 'false' ?>, "maxAmount": <?= json_encode((float)$refundable) ?>, "messages": {"partialDisabled": "<?= $escaper->escapeJs(__('Partial refunds are disabled.')) ?>", "invalidAmount": "<?= $escaper->escapeJs(__('Please enter a valid amount greater than 0 and up to %1', number_format((float)$refundable, 2))) ?>", "noQty": "<?= $escaper->escapeJs(__('Please enter at least one quantity to refund.')) ?>", "noComment": "<?= $escaper->escapeJs(__('Please enter a reason/comment for this refund.')) ?>"}}}'>
    <?= /* form key */
    $block->getBlockHtml('formkey') ?>
    <input type="hidden" name="order_id" value="<?= (int)$order->getId() ?>"/>
    <section class="admin__page-section order-view-account-information">
        <div class="admin__page-section-content">
            <div class="admin__page-section-item order-information">
                <div class="admin__page-section-item-title">
                    <span class="title">
                        <?= $escaper->escapeHtml(__('Request Fintoc Refund for Order #%1', $order->getIncrementId())) ?>
                    </span>
                </div>
                <div class="admin__page-section-item-content">
                    <table class="admin__table-secondary order-information-table">
                        <tbody>
                        <tr>
                            <th><?= $escaper->escapeHtml(__('Refund Mode')) ?></th>
                            <td>
                                <fieldset class="admin__fieldset">
                                    <div class="admin__field field">
                                        <div class="control">
                                            <label class="admin__field-option">
                                                <input type="radio" name="mode" value="full" checked="checked"/>
                                                <span><?= $escaper->escapeHtml(__('Full refundable amount')) ?></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="admin__field field">
                                        <div class="control">
                                            <label class="admin__field-option">
                                                <input type="radio" name="mode"
                                                       value="items" <?= $allowPartial ? '' : 'disabled="disabled"' ?> />
                                                <span><?= $escaper->escapeHtml(__('Partial by items/quantities')) ?></span>
                                            </label>
                                        </div>
                                    </div>
                                </fieldset>
                            </td>
                        </tr>
                        <tr>
                            <th><?= $escaper->escapeHtml(__('Reason / Comment')) ?></th>
                            <td>
                                <div class="admin__field field" style="margin-top:15px;">
                                    <div class="control">
                                        <textarea name="comment" id="comment" rows="3" style="width: 600px;" required="required" class="required-entry" data-validate='{"required":true}' aria-required="true"></textarea>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="admin__page-section-item order-account-information">
                <div class="admin__page-section-item-title">
                    <span class="title"><?= __('Order Information') ?></span>
                </div>
                <div class="admin__page-section-item-content">
                    <table class="admin__table-secondary order-information-table">
                        <tbody>
                        <tr>
                            <th><?= __('Order Date')?></th>
                            <td><?= $order->getCreatedAt() ?></td>
                        </tr>
                        <tr>
                            <th>Order Status</th>
                            <td><span id="order_status"><?= $order->getStatus() ?></span></td>
                        </tr>
                        <tr>
                            <th><?= $escaper->escapeHtml(__('Order Total Paid')) ?></th>
                            <td><?= /* @noEscape */
                                $order->formatPrice((float)($order->getTotalPaid() ?: $order->getGrandTotal())) ?></td>
                        </tr>
                        <tr>
                            <th><?= $escaper->escapeHtml(__('Refundable Amount')) ?></th>
                            <td><?= /* @noEscape */
                                $block->formatPrice($order, $refundable) ?></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="admin__page-section-content">
            <div id="items-section" style="display:none; margin-top:15px;">
                <div class="admin__control-table-wrapper">
                    <table class="data-table admin__control-table">
                        <thead>
                        <tr>
                            <th><?= $escaper->escapeHtml(__('Product')) ?></th>
                            <th><?= $escaper->escapeHtml(__('SKU')) ?></th>
                            <th><?= $escaper->escapeHtml(__('Qty to refund')) ?></th>
                            <th><?= $escaper->escapeHtml(__('Max Qty')) ?></th>
                            <th><?= $escaper->escapeHtml(__('Unit Price (incl. tax)')) ?></th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php if (!$items): ?>
                            <tr>
                                <td colspan="5"><em><?= $escaper->escapeHtml(__('No refundable items.')) ?></em></td>
                            </tr>
                        <?php else: ?>
                            <?php foreach ($items as $it): ?>
                                <tr>
                                    <td><?= $escaper->escapeHtml($it['name']) ?></td>
                                    <td><?= $escaper->escapeHtml($it['sku']) ?></td>
                                    <td>
                                        <input type="number" class="input-text" step="1" min="0"
                                               max="<?= (float)$it['max_qty'] ?>" name="qty[<?= (int)$it['item_id'] ?>]"
                                               style="width:100px;"/>
                                    </td>
                                    <td><?= $escaper->escapeHtml(number_format((float)$it['max_qty'], 2)) ?></td>
                                    <td><?= $escaper->escapeHtml(number_format((float)$it['price_incl_tax'], 2)) ?></td>
                                </tr>
                            <?php endforeach; ?>
                        <?php endif; ?>
                        </tbody>
                    </table>
                </div>
                <div class="note">
                    <?= $escaper->escapeHtml(__('The final refund amount will be computed from selected item quantities.')) ?>
                </div>
            </div>

            <div class="actions" style="margin-top:20px;">
                <button type="submit" class="action-primary">
                    <span><?= $escaper->escapeHtml(__('Request Refund')) ?></span></button>
                <a class="action-secondary"
                   href="<?= $escaper->escapeUrl($block->getUrl('fintoc_refunds/orders/index')) ?>"
                   style="margin-left:10px;">
                    <?= $escaper->escapeHtml(__('Cancel')) ?>
                </a>
            </div>
        </div>
    </section>
</form>
